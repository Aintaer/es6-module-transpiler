"use strict";
var $__getDescriptors = function(object) {
  var descriptors = {}, name, names = Object.getOwnPropertyNames(object);
  for (var i = 0; i < names.length; i++) {
    var name = names[i];
    descriptors[name] = Object.getOwnPropertyDescriptor(object, name);
  }
  return descriptors;
}, $__createClassNoExtends = function(object, staticObject) {
  var ctor = object.constructor;
  Object.defineProperty(object, 'constructor', {enumerable: false});
  ctor.prototype = object;
  Object.defineProperties(ctor, $__getDescriptors(staticObject));
  return ctor;
};
var optimist = require("optimist");
var fs = require("fs");
var path = require("path");
var CLI = function() {
  'use strict';
  var $CLI = ($__createClassNoExtends)({
    constructor: function(Compiler, stdin, stdout, fs_) {
      this.Compiler = Compiler;
      this.stdin = stdin != null ? stdin: process.stdin;
      this.stdout = stdout != null ? stdout: process.stdout;
      this.fs = fs_ != null ? fs_: fs;
    },
    start: function(argv) {
      var filename, options, _i, _len, _ref;
      options = this.parseArgs(argv);
      if (options.help) {
        this.argParser(argv).showHelp();
        return;
      }
      if (options.stdio) {
        this.processStdio(options);
      } else {
        _ref = options._;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          filename = _ref[_i];
          this.processPath(filename, options);
        }
      }
      return null;
    },
    parseArgs: function(argv) {
      var args, global, imports, pair, requirePath, _i, _len, _ref, _ref1;
      args = this.argParser(argv).argv;
      if (args.imports) {
        imports = {};
        _ref = args.imports.split(',');
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          pair = _ref[_i];
          _ref1 = pair.split(':'), requirePath = _ref1[0], global = _ref1[1];
          imports[requirePath] = global;
        }
        args.imports = imports;
      }
      if (args.global) {
        args.into = args.global;
      }
      return args;
    },
    argParser: function(argv) {
      return optimist(argv).usage('compile-modules usage:\n\n  Using files:\n    compile-modules INPUT --to DIR [--anonymous] [--type TYPE] [--imports PATH:GLOBAL]\n\n  Using stdio:\n    compile-modules --stdio [--coffee] [--type TYPE] [--imports PATH:GLOBAL] (--module-name MOD|--anonymous)').options({
        type: {
          "default": 'amd',
          describe: 'The type of output (one of "amd", "cjs", or "globals")'
        },
        to: {describe: 'A directory in which to write the resulting files'},
        imports: {describe: 'A list of path:global pairs, comma separated (e.g. jquery:$,ember:Ember)'},
        anonymous: {
          "default": false,
          type: 'boolean',
          describe: 'Do not include a module name'
        },
        'module-name': {
          describe: 'The name of the outputted module',
          alias: 'm'
        },
        stdio: {
          "default": false,
          type: 'boolean',
          alias: 's',
          describe: 'Use stdin and stdout to process a file'
        },
        coffee: {
          "default": false,
          type: 'boolean',
          describe: 'Process stdin as CoffeeScript (requires --stdio)'
        },
        global: {describe: 'When the type is `globals`, the name of the global to export into'},
        help: {
          "default": false,
          type: 'boolean',
          alias: 'h',
          describe: 'Shows this help message'
        }
      }).check(function(args) {
        var _ref;
        return (_ref = args.type) === 'amd' || _ref === 'cjs' || _ref === 'globals';
      }).check(function(args) {
        return !(args.anonymous && args.m);
      }).check(function(args) {
        if (args.stdio && args.type === 'amd') {
          return args.anonymous || args.m || false;
        } else {
          return true;
        }
      }).check(function(args) {
        return !(args.coffee && !args.stdio);
      }).check(function(args) {
        return args.stdio || args.to || args.help;
      }).check(function(args) {
        if (args.imports) {
          return args.type === 'globals';
        } else {
          return true;
        }
      });
    },
    processStdio: function(options) {
      var input, _this = this;
      input = '';
      this.stdin.resume();
      this.stdin.setEncoding('utf8');
      this.stdin.on('data', function(data) {
        return input += data;
      });
      return this.stdin.on('end', function() {
        var output;
        output = _this._compile(input, options.m, options.type, options);
        return _this.stdout.write(output);
      });
    },
    processPath: function(filename, options) {
      var _this = this;
      return this.fs.stat(filename, function(err, stat) {
        if (err) {
          console.error(err.message);
          return process.exit(1);
        } else if (stat.isDirectory()) {
          return _this.processDirectory(filename, options);
        } else {
          return _this.processFile(filename, options);
        }
      });
    },
    processDirectory: function(dirname, options) {
      var _this = this;
      return this.fs.readdir(dirname, function(err, children) {
        var child, _i, _len, _results;
        if (err) {
          console.error(err.message);
          process.exit(1);
        }
        _results = [];
        for (_i = 0, _len = children.length; _i < _len; _i++) {
          child = children[_i];
          _results.push(_this.processPath(path.join(dirname, child), options));
        }
        return _results;
      });
    },
    processFile: function(filename, options) {
      var _this = this;
      return this.fs.readFile(filename, 'utf8', function(err, input) {
        var ext, moduleName, output, outputFilename;
        ext = path.extname(filename);
        if (!options.anonymous) {
          moduleName = path.join(path.dirname(filename), path.basename(filename, ext)).replace(/[\\]/g, '/');
        }
        output = _this._compile(input, moduleName, options.type, {
          coffee: ext === '.coffee',
          imports: options.imports
        });
        outputFilename = path.join(options.to, filename).replace(/[\\]/g, '/');
        _this._mkdirp(path.dirname(outputFilename));
        return _this.fs.writeFile(outputFilename, output, 'utf8', function(err) {
          if (err) {
            console.error(err.message);
            return process.exit(1);
          }
        });
      });
    },
    _compile: function(input, moduleName, type, options) {
      var compiler, method;
      type = {
        amd: 'AMD',
        cjs: 'CJS',
        globals: 'Globals'
      }[type];
      compiler = new this.Compiler(input, moduleName, options);
      method = "to" + type;
      return compiler[method]();
    },
    _mkdirp: function(directory) {
      var prefix;
      if (this.fs.existsSync(directory)) {
        return;
      }
      prefix = path.dirname(directory);
      if (prefix !== '.' && prefix !== '/') {
        this._mkdirp(prefix);
      }
      return this.fs.mkdirSync(directory);
    }
  }, {});
  return $CLI;
}();
CLI.start = function(Compiler, argv, stdin, stdout, fs_) {
  if (stdin == null) {
    stdin = process.stdin;
  }
  if (stdout == null) {
    stdout = process.stdout;
  }
  if (fs_ == null) {
    fs_ = fs;
  }
  return new CLI(Compiler, stdin, stdout, fs_).start(argv);
};
module.exports = CLI;

//@ sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG1wL3RyYW5zcGlsZWQvY2xpLmpzLmVzNiIsInNvdXJjZXMiOlsidG1wL3RyYW5zcGlsZWQvY2xpLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQUE7dUJDQUEsU0FBQSxDQUFTLE1BQUEsQ0FBUTtBQUNMLEtBQUEsWUFBQSxFQUFjLEVBQUEsQ0FBQSxDQUFJLEtBQUEsQ0FBTSxNQUFBLEVBQVEsT0FBQSxDQUFBLG1CQUEwQixDQUFDLE1BQUEsQ0FBQTtBQUMvRCxLQUFBLEVBQVMsR0FBQSxFQUFBLEVBQUksRUFBQSxDQUFHLEVBQUEsRUFBSSxNQUFBLENBQUEsTUFBQSxDQUFjLEVBQUEsRUFBQSxDQUFLO0FBQ2pDLE9BQUEsS0FBQSxFQUFPLE1BQUEsQ0FBTSxDQUFBLENBQUE7QUFDakIsZUFBQSxDQUFZLElBQUEsQ0FBQSxFQUFRLE9BQUEsQ0FBQSx3QkFBK0IsQ0FBQyxNQUFBLENBQVEsS0FBQSxDQUFBO0FBQUE7QUFFOUQsUUFBTyxZQUFBO0FBQUEsQ0FBQSwyQkNOZixTQUFBLENBQVMsTUFBQSxDQUFRLGFBQUEsQ0FBYztBQUNyQixLQUFBLEtBQUEsRUFBTyxPQUFBLENBQUEsV0FBQTtBQUNYLFFBQUEsQ0FBQSxjQUFxQixDQUFDLE1BQUEsQ0FBUSxjQUFBLENBQWUsRUFBQyxVQUFBLENBQVksTUFBQSxDQUFBLENBQUE7QUFDMUQsTUFBQSxDQUFBLFNBQUEsRUFBaUIsT0FBQTtBQUNqQixRQUFBLENBQUEsZ0JBQXVCLENBQUMsSUFBQSxDQUFNLGtCQUFpQixDQUFDLFlBQUEsQ0FBQSxDQUFBO0FBQ2hELFFBQU8sS0FBQTtBQUFBLENBQUE7QUZKVCxHQUFBLFNBQUEsRUFBVyxRQUFPLENBQUMsVUFBQSxDQUFBO0FBQ25CLEdBQUEsR0FBQSxFQUFLLFFBQU8sQ0FBQyxJQUFBLENBQUE7QUFDYixHQUFBLEtBQUEsRUFBTyxRQUFPLENBQUMsTUFBQSxDQUFBO0dBRWIsSUFBQSxFR0xOLFNBQUEsQ0FBUyxDQUFFO0FBQ0wsY0FBQTtBQUNJLFlB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O0FBRUYsWUFBQSxFQUFTLEtBQUEsQ0FBQSxPQUFZLENBQUMsU0FBQSxDQUFBO0FBQ3RCLFFBQUEsRUFBSSxNQUFBLElBQVcsSUFBQSxHQUFPLE9BQUEsSUFBVyxJQUFBLENBQUs7QUFDcEMsWUFBQSxDQUFBLE9BQVksQ0FBQyxNQUFBLENBQUE7QUFBQTtBQUVmLFlBQU8sS0FBQSxDQUFBLEVBQUEsQ0FBQSxTQUFpQixDQUFDLFNBQUEsQ0FBQTtBQUFBO0FBQUEsR0FBQTtBRzNNdkI7Q0FDRCxDQUFBLENBQUE7QUg4TUwsR0FBQSxDQUFBLEtBQUEsRUFBWSxTQUFBLENBQVMsUUFBQSxDQUFVLEtBQUEsQ0FBTSxNQUFBLENBQU8sT0FBQSxDQUFRLElBQUEsQ0FBSztBQUN2RCxJQUFBLEVBQUksS0FBQSxHQUFTLEtBQUEsQ0FBTTtBQUNqQixTQUFBLEVBQVEsUUFBQSxDQUFBLEtBQUE7QUFBQTtBQUVWLElBQUEsRUFBSSxNQUFBLEdBQVUsS0FBQSxDQUFNO0FBQ2xCLFVBQUEsRUFBUyxRQUFBLENBQUEsTUFBQTtBQUFBO0FBRVgsSUFBQSxFQUFJLEdBQUEsR0FBTyxLQUFBLENBQU07QUFDZixPQUFBLEVBQU0sR0FBQTtBQUFBO0FBRVIsUUFBTyxJQUFJLElBQUcsQ0FBQyxRQUFBLENBQVUsTUFBQSxDQUFPLE9BQUEsQ0FBUSxJQUFBLENBQUEsQ0FBQSxLQUFVLENBQUMsSUFBQSxDQUFBO0FBQUEsQ0FBQTtBQUlyRCxNQUFBLENBQUEsT0FBQSxFQUFpQixJQUFBIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG52YXIgb3B0aW1pc3QgPSByZXF1aXJlKFwib3B0aW1pc3RcIik7XG52YXIgZnMgPSByZXF1aXJlKFwiZnNcIik7XG52YXIgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xuXG5jbGFzcyBDTEkge1xuICBjb25zdHJ1Y3RvcihDb21waWxlciwgc3RkaW4sIHN0ZG91dCwgZnNfKSB7XG4gICAgdGhpcy5Db21waWxlciA9IENvbXBpbGVyO1xuICAgIHRoaXMuc3RkaW4gPSBzdGRpbiAhPSBudWxsID8gc3RkaW4gOiBwcm9jZXNzLnN0ZGluO1xuICAgIHRoaXMuc3Rkb3V0ID0gc3Rkb3V0ICE9IG51bGwgPyBzdGRvdXQgOiBwcm9jZXNzLnN0ZG91dDtcbiAgICB0aGlzLmZzID0gZnNfICE9IG51bGwgPyBmc18gOiBmcztcbiAgfVxuXG4gIHN0YXJ0KGFyZ3YpIHtcbiAgICB2YXIgZmlsZW5hbWUsIG9wdGlvbnMsIF9pLCBfbGVuLCBfcmVmO1xuICAgIG9wdGlvbnMgPSB0aGlzLnBhcnNlQXJncyhhcmd2KTtcbiAgICBpZiAob3B0aW9ucy5oZWxwKSB7XG4gICAgICB0aGlzLmFyZ1BhcnNlcihhcmd2KS5zaG93SGVscCgpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAob3B0aW9ucy5zdGRpbykge1xuICAgICAgdGhpcy5wcm9jZXNzU3RkaW8ob3B0aW9ucyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIF9yZWYgPSBvcHRpb25zLl87XG4gICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IF9yZWYubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHtcbiAgICAgICAgZmlsZW5hbWUgPSBfcmVmW19pXTtcbiAgICAgICAgdGhpcy5wcm9jZXNzUGF0aChmaWxlbmFtZSwgb3B0aW9ucyk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgcGFyc2VBcmdzKGFyZ3YpIHtcbiAgICB2YXIgYXJncywgZ2xvYmFsLCBpbXBvcnRzLCBwYWlyLCByZXF1aXJlUGF0aCwgX2ksIF9sZW4sIF9yZWYsIF9yZWYxO1xuICAgIGFyZ3MgPSB0aGlzLmFyZ1BhcnNlcihhcmd2KS5hcmd2O1xuICAgIGlmIChhcmdzLmltcG9ydHMpIHtcbiAgICAgIGltcG9ydHMgPSB7fTtcbiAgICAgIF9yZWYgPSBhcmdzLmltcG9ydHMuc3BsaXQoJywnKTtcbiAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gX3JlZi5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykge1xuICAgICAgICBwYWlyID0gX3JlZltfaV07XG4gICAgICAgIF9yZWYxID0gcGFpci5zcGxpdCgnOicpLCByZXF1aXJlUGF0aCA9IF9yZWYxWzBdLCBnbG9iYWwgPSBfcmVmMVsxXTtcbiAgICAgICAgaW1wb3J0c1tyZXF1aXJlUGF0aF0gPSBnbG9iYWw7XG4gICAgICB9XG4gICAgICBhcmdzLmltcG9ydHMgPSBpbXBvcnRzO1xuICAgIH1cbiAgICBpZiAoYXJncy5nbG9iYWwpIHtcbiAgICAgIGFyZ3MuaW50byA9IGFyZ3MuZ2xvYmFsO1xuICAgIH1cbiAgICByZXR1cm4gYXJncztcbiAgfVxuXG4gIGFyZ1BhcnNlcihhcmd2KSB7XG4gICAgcmV0dXJuIG9wdGltaXN0KGFyZ3YpLnVzYWdlKCdjb21waWxlLW1vZHVsZXMgdXNhZ2U6XFxuXFxuICBVc2luZyBmaWxlczpcXG4gICAgY29tcGlsZS1tb2R1bGVzIElOUFVUIC0tdG8gRElSIFstLWFub255bW91c10gWy0tdHlwZSBUWVBFXSBbLS1pbXBvcnRzIFBBVEg6R0xPQkFMXVxcblxcbiAgVXNpbmcgc3RkaW86XFxuICAgIGNvbXBpbGUtbW9kdWxlcyAtLXN0ZGlvIFstLWNvZmZlZV0gWy0tdHlwZSBUWVBFXSBbLS1pbXBvcnRzIFBBVEg6R0xPQkFMXSAoLS1tb2R1bGUtbmFtZSBNT0R8LS1hbm9ueW1vdXMpJykub3B0aW9ucyh7XG4gICAgICB0eXBlOiB7XG4gICAgICAgIFwiZGVmYXVsdFwiOiAnYW1kJyxcbiAgICAgICAgZGVzY3JpYmU6ICdUaGUgdHlwZSBvZiBvdXRwdXQgKG9uZSBvZiBcImFtZFwiLCBcImNqc1wiLCBvciBcImdsb2JhbHNcIiknXG4gICAgICB9LFxuICAgICAgdG86IHtcbiAgICAgICAgZGVzY3JpYmU6ICdBIGRpcmVjdG9yeSBpbiB3aGljaCB0byB3cml0ZSB0aGUgcmVzdWx0aW5nIGZpbGVzJ1xuICAgICAgfSxcbiAgICAgIGltcG9ydHM6IHtcbiAgICAgICAgZGVzY3JpYmU6ICdBIGxpc3Qgb2YgcGF0aDpnbG9iYWwgcGFpcnMsIGNvbW1hIHNlcGFyYXRlZCAoZS5nLiBqcXVlcnk6JCxlbWJlcjpFbWJlciknXG4gICAgICB9LFxuICAgICAgYW5vbnltb3VzOiB7XG4gICAgICAgIFwiZGVmYXVsdFwiOiBmYWxzZSxcbiAgICAgICAgdHlwZTogJ2Jvb2xlYW4nLFxuICAgICAgICBkZXNjcmliZTogJ0RvIG5vdCBpbmNsdWRlIGEgbW9kdWxlIG5hbWUnXG4gICAgICB9LFxuICAgICAgJ21vZHVsZS1uYW1lJzoge1xuICAgICAgICBkZXNjcmliZTogJ1RoZSBuYW1lIG9mIHRoZSBvdXRwdXR0ZWQgbW9kdWxlJyxcbiAgICAgICAgYWxpYXM6ICdtJ1xuICAgICAgfSxcbiAgICAgIHN0ZGlvOiB7XG4gICAgICAgIFwiZGVmYXVsdFwiOiBmYWxzZSxcbiAgICAgICAgdHlwZTogJ2Jvb2xlYW4nLFxuICAgICAgICBhbGlhczogJ3MnLFxuICAgICAgICBkZXNjcmliZTogJ1VzZSBzdGRpbiBhbmQgc3Rkb3V0IHRvIHByb2Nlc3MgYSBmaWxlJ1xuICAgICAgfSxcbiAgICAgIGNvZmZlZToge1xuICAgICAgICBcImRlZmF1bHRcIjogZmFsc2UsXG4gICAgICAgIHR5cGU6ICdib29sZWFuJyxcbiAgICAgICAgZGVzY3JpYmU6ICdQcm9jZXNzIHN0ZGluIGFzIENvZmZlZVNjcmlwdCAocmVxdWlyZXMgLS1zdGRpbyknXG4gICAgICB9LFxuICAgICAgZ2xvYmFsOiB7XG4gICAgICAgIGRlc2NyaWJlOiAnV2hlbiB0aGUgdHlwZSBpcyBgZ2xvYmFsc2AsIHRoZSBuYW1lIG9mIHRoZSBnbG9iYWwgdG8gZXhwb3J0IGludG8nXG4gICAgICB9LFxuICAgICAgaGVscDoge1xuICAgICAgICBcImRlZmF1bHRcIjogZmFsc2UsXG4gICAgICAgIHR5cGU6ICdib29sZWFuJyxcbiAgICAgICAgYWxpYXM6ICdoJyxcbiAgICAgICAgZGVzY3JpYmU6ICdTaG93cyB0aGlzIGhlbHAgbWVzc2FnZSdcbiAgICAgIH1cbiAgICB9KS5jaGVjayhmdW5jdGlvbihhcmdzKSB7XG4gICAgICB2YXIgX3JlZjtcbiAgICAgIHJldHVybiAoX3JlZiA9IGFyZ3MudHlwZSkgPT09ICdhbWQnIHx8IF9yZWYgPT09ICdjanMnIHx8IF9yZWYgPT09ICdnbG9iYWxzJztcbiAgICB9KS5jaGVjayhmdW5jdGlvbihhcmdzKSB7XG4gICAgICByZXR1cm4gIShhcmdzLmFub255bW91cyAmJiBhcmdzLm0pO1xuICAgIH0pLmNoZWNrKGZ1bmN0aW9uKGFyZ3MpIHtcbiAgICAgIGlmIChhcmdzLnN0ZGlvICYmIGFyZ3MudHlwZSA9PT0gJ2FtZCcpIHtcbiAgICAgICAgcmV0dXJuIGFyZ3MuYW5vbnltb3VzIHx8IGFyZ3MubSB8fCBmYWxzZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH0pLmNoZWNrKGZ1bmN0aW9uKGFyZ3MpIHtcbiAgICAgIHJldHVybiAhKGFyZ3MuY29mZmVlICYmICFhcmdzLnN0ZGlvKTtcbiAgICB9KS5jaGVjayhmdW5jdGlvbihhcmdzKSB7XG4gICAgICByZXR1cm4gYXJncy5zdGRpbyB8fCBhcmdzLnRvIHx8IGFyZ3MuaGVscDtcbiAgICB9KS5jaGVjayhmdW5jdGlvbihhcmdzKSB7XG4gICAgICBpZiAoYXJncy5pbXBvcnRzKSB7XG4gICAgICAgIHJldHVybiBhcmdzLnR5cGUgPT09ICdnbG9iYWxzJztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJvY2Vzc1N0ZGlvKG9wdGlvbnMpIHtcbiAgICB2YXIgaW5wdXQsXG4gICAgICBfdGhpcyA9IHRoaXM7XG4gICAgaW5wdXQgPSAnJztcbiAgICB0aGlzLnN0ZGluLnJlc3VtZSgpO1xuICAgIHRoaXMuc3RkaW4uc2V0RW5jb2RpbmcoJ3V0ZjgnKTtcbiAgICB0aGlzLnN0ZGluLm9uKCdkYXRhJywgZnVuY3Rpb24oZGF0YSkge1xuICAgICAgcmV0dXJuIGlucHV0ICs9IGRhdGE7XG4gICAgfSk7XG4gICAgcmV0dXJuIHRoaXMuc3RkaW4ub24oJ2VuZCcsIGZ1bmN0aW9uKCkge1xuICAgICAgdmFyIG91dHB1dDtcbiAgICAgIG91dHB1dCA9IF90aGlzLl9jb21waWxlKGlucHV0LCBvcHRpb25zLm0sIG9wdGlvbnMudHlwZSwgb3B0aW9ucyk7XG4gICAgICByZXR1cm4gX3RoaXMuc3Rkb3V0LndyaXRlKG91dHB1dCk7XG4gICAgfSk7XG4gIH1cblxuICBwcm9jZXNzUGF0aChmaWxlbmFtZSwgb3B0aW9ucykge1xuICAgIHZhciBfdGhpcyA9IHRoaXM7XG4gICAgcmV0dXJuIHRoaXMuZnMuc3RhdChmaWxlbmFtZSwgZnVuY3Rpb24oZXJyLCBzdGF0KSB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyLm1lc3NhZ2UpO1xuICAgICAgICByZXR1cm4gcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgfSBlbHNlIGlmIChzdGF0LmlzRGlyZWN0b3J5KCkpIHtcbiAgICAgICAgcmV0dXJuIF90aGlzLnByb2Nlc3NEaXJlY3RvcnkoZmlsZW5hbWUsIG9wdGlvbnMpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIF90aGlzLnByb2Nlc3NGaWxlKGZpbGVuYW1lLCBvcHRpb25zKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHByb2Nlc3NEaXJlY3RvcnkoZGlybmFtZSwgb3B0aW9ucykge1xuICAgIHZhciBfdGhpcyA9IHRoaXM7XG4gICAgcmV0dXJuIHRoaXMuZnMucmVhZGRpcihkaXJuYW1lLCBmdW5jdGlvbihlcnIsIGNoaWxkcmVuKSB7XG4gICAgICB2YXIgY2hpbGQsIF9pLCBfbGVuLCBfcmVzdWx0cztcbiAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnIubWVzc2FnZSk7XG4gICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgIH1cbiAgICAgIF9yZXN1bHRzID0gW107XG4gICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IGNoaWxkcmVuLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7XG4gICAgICAgIGNoaWxkID0gY2hpbGRyZW5bX2ldO1xuICAgICAgICBfcmVzdWx0cy5wdXNoKF90aGlzLnByb2Nlc3NQYXRoKHBhdGguam9pbihkaXJuYW1lLCBjaGlsZCksIG9wdGlvbnMpKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBfcmVzdWx0cztcbiAgICB9KTtcbiAgfVxuXG4gIHByb2Nlc3NGaWxlKGZpbGVuYW1lLCBvcHRpb25zKSB7XG4gICAgdmFyIF90aGlzID0gdGhpcztcbiAgICByZXR1cm4gdGhpcy5mcy5yZWFkRmlsZShmaWxlbmFtZSwgJ3V0ZjgnLCBmdW5jdGlvbihlcnIsIGlucHV0KSB7XG4gICAgICB2YXIgZXh0LCBtb2R1bGVOYW1lLCBvdXRwdXQsIG91dHB1dEZpbGVuYW1lO1xuICAgICAgZXh0ID0gcGF0aC5leHRuYW1lKGZpbGVuYW1lKTtcbiAgICAgIGlmICghb3B0aW9ucy5hbm9ueW1vdXMpIHtcbiAgICAgICAgbW9kdWxlTmFtZSA9IHBhdGguam9pbihwYXRoLmRpcm5hbWUoZmlsZW5hbWUpLCBwYXRoLmJhc2VuYW1lKGZpbGVuYW1lLCBleHQpKS5yZXBsYWNlKC9bXFxcXF0vZywgJy8nKTtcbiAgICAgIH1cbiAgICAgIG91dHB1dCA9IF90aGlzLl9jb21waWxlKGlucHV0LCBtb2R1bGVOYW1lLCBvcHRpb25zLnR5cGUsIHtcbiAgICAgICAgY29mZmVlOiBleHQgPT09ICcuY29mZmVlJyxcbiAgICAgICAgaW1wb3J0czogb3B0aW9ucy5pbXBvcnRzXG4gICAgICB9KTtcbiAgICAgIG91dHB1dEZpbGVuYW1lID0gcGF0aC5qb2luKG9wdGlvbnMudG8sIGZpbGVuYW1lKS5yZXBsYWNlKC9bXFxcXF0vZywgJy8nKTtcbiAgICAgIF90aGlzLl9ta2RpcnAocGF0aC5kaXJuYW1lKG91dHB1dEZpbGVuYW1lKSk7XG4gICAgICByZXR1cm4gX3RoaXMuZnMud3JpdGVGaWxlKG91dHB1dEZpbGVuYW1lLCBvdXRwdXQsICd1dGY4JywgZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKGVyci5tZXNzYWdlKTtcbiAgICAgICAgICByZXR1cm4gcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIF9jb21waWxlKGlucHV0LCBtb2R1bGVOYW1lLCB0eXBlLCBvcHRpb25zKSB7XG4gICAgdmFyIGNvbXBpbGVyLCBtZXRob2Q7XG4gICAgdHlwZSA9IHtcbiAgICAgIGFtZDogJ0FNRCcsXG4gICAgICBjanM6ICdDSlMnLFxuICAgICAgZ2xvYmFsczogJ0dsb2JhbHMnXG4gICAgfVt0eXBlXTtcbiAgICBjb21waWxlciA9IG5ldyB0aGlzLkNvbXBpbGVyKGlucHV0LCBtb2R1bGVOYW1lLCBvcHRpb25zKTtcbiAgICBtZXRob2QgPSBcInRvXCIgKyB0eXBlO1xuICAgIHJldHVybiBjb21waWxlclttZXRob2RdKCk7XG4gIH1cblxuICBfbWtkaXJwKGRpcmVjdG9yeSkge1xuICAgIHZhciBwcmVmaXg7XG4gICAgaWYgKHRoaXMuZnMuZXhpc3RzU3luYyhkaXJlY3RvcnkpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHByZWZpeCA9IHBhdGguZGlybmFtZShkaXJlY3RvcnkpO1xuICAgIGlmIChwcmVmaXggIT09ICcuJyAmJiBwcmVmaXggIT09ICcvJykge1xuICAgICAgdGhpcy5fbWtkaXJwKHByZWZpeCk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmZzLm1rZGlyU3luYyhkaXJlY3RvcnkpO1xuICB9XG59XG5cbkNMSS5zdGFydCA9IGZ1bmN0aW9uKENvbXBpbGVyLCBhcmd2LCBzdGRpbiwgc3Rkb3V0LCBmc18pIHtcbiAgaWYgKHN0ZGluID09IG51bGwpIHtcbiAgICBzdGRpbiA9IHByb2Nlc3Muc3RkaW47XG4gIH1cbiAgaWYgKHN0ZG91dCA9PSBudWxsKSB7XG4gICAgc3Rkb3V0ID0gcHJvY2Vzcy5zdGRvdXQ7XG4gIH1cbiAgaWYgKGZzXyA9PSBudWxsKSB7XG4gICAgZnNfID0gZnM7XG4gIH1cbiAgcmV0dXJuIG5ldyBDTEkoQ29tcGlsZXIsIHN0ZGluLCBzdGRvdXQsIGZzXykuc3RhcnQoYXJndik7XG59O1xuXG5cbm1vZHVsZS5leHBvcnRzID0gQ0xJOyJdfQ==