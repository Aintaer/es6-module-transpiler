"use strict";
var $__getDescriptors = function(object) {
  var descriptors = {}, name, names = Object.getOwnPropertyNames(object);
  for (var i = 0; i < names.length; i++) {
    var name = names[i];
    descriptors[name] = Object.getOwnPropertyDescriptor(object, name);
  }
  return descriptors;
}, $__createClassNoExtends = function(object, staticObject) {
  var ctor = object.constructor;
  Object.defineProperty(object, 'constructor', {enumerable: false});
  ctor.prototype = object;
  Object.defineProperties(ctor, $__getDescriptors(staticObject));
  return ctor;
};
var optimist = require("optimist");
var fs = require("fs");
var path = require("path");
var through = require("through");
function extend(target) {
  for (var sources = [], $__1 = 1; $__1 < arguments.length; $__1++) sources[$__1 - 1] = arguments[$__1];
  var toString = {}.toString;
  sources.forEach(function(source) {
    for (var key in source) {
      target[key] = source[key];
    }
  });
  return target;
}
var CLI = function() {
  'use strict';
  var $CLI = ($__createClassNoExtends)({
    constructor: function(Compiler) {
      var stdin = arguments[1] !== (void 0) ? arguments[1]: process.stdin;
      var stdout = arguments[2] !== (void 0) ? arguments[2]: process.stdout;
      var fs_ = arguments[3] !== (void 0) ? arguments[3]: fs;
      this.Compiler = Compiler;
      this.stdin = stdin;
      this.stdout = stdout;
      this.fs = fs_;
    },
    start: function(argv) {
      var options = this.parseArgs(argv);
      if (options.help) {
        this.argParser(argv).showHelp();
      } else if (options.stdio) {
        this.processStdio(options);
      } else {
        for (var i = 0; i < options._.length; i++) {
          var filename = options._[i];
          this.processPath(filename, options);
        }
      }
    },
    parseArgs: function(argv) {
      var args = this.argParser(argv).argv;
      if (args.imports) {
        var imports = {};
        args.imports.split(',').forEach(function(pair) {
          var $__2 = pair.split(':'), requirePath = $__2[0], global = $__2[1];
          imports[requirePath] = global;
        });
        args.imports = imports;
      }
      if (args.global) {
        args.into = args.global;
      }
      return args;
    },
    argParser: function(argv) {
      return optimist(argv).usage('compile-modules usage:\n\n  Using files:\n    compile-modules INPUT --to DIR [--anonymous] [--type TYPE] [--imports PATH:GLOBAL]\n\n  Using stdio:\n    compile-modules --stdio [--type TYPE] [--imports PATH:GLOBAL] (--module-name MOD|--anonymous)').options({
        type: {
          "default": 'amd',
          describe: 'The type of output (one of "amd", "cjs", or "globals")'
        },
        to: {describe: 'A directory in which to write the resulting files'},
        imports: {describe: 'A list of path:global pairs, comma separated (e.g. jquery:$,ember:Ember)'},
        anonymous: {
          "default": false,
          type: 'boolean',
          describe: 'Do not include a module name'
        },
        'module-name': {
          describe: 'The name of the outputted module',
          alias: 'm'
        },
        stdio: {
          "default": false,
          type: 'boolean',
          alias: 's',
          describe: 'Use stdin and stdout to process a file'
        },
        global: {describe: 'When the type is `globals`, the name of the global to export into'},
        help: {
          "default": false,
          type: 'boolean',
          alias: 'h',
          describe: 'Shows this help message'
        }
      }).check((function($__2) {
        var type = $__2.type;
        return type === 'amd' || type === 'cjs' || type === 'globals';
      })).check((function(args) {
        return !args.anonymous || !args.m;
      })).check((function(args) {
        return (args.stdio && args.type === 'amd') ? args.anonymous || args.m || false: true;
      })).check((function(args) {
        return args.stdio || args.to || args.help;
      })).check((function(args) {
        return args.imports ? args.type === 'globals': args.type !== 'globals';
      }));
    },
    processStdio: function(options) {
      this.processIO(this.stdin, this.stdout, options);
    },
    processIO: function(input, output, options) {
      try {
        throw undefined;
      } catch (end) {
        try {
          throw undefined;
        } catch (write) {
          var data = '', self = this;
          write = function(chunk) {
            data += chunk;
          };
          end = function() {
            this.queue(self._compile(data, options.m, options.type, options));
            this.queue(null);
          };
          input.pipe(through(write, end)).pipe(output);
        }
      }
    },
    processPath: function(filename, options) {
      this.fs.stat(filename, function(err, stat) {
        if (err) {
          console.error(err.message);
          process.exit(1);
        } else if (stat.isDirectory()) {
          this.processDirectory(filename, options);
        } else {
          this.processFile(filename, options);
        }
      }.bind(this));
    },
    processDirectory: function(dirname, options) {
      this.fs.readdir(dirname, function(err, children) {
        if (err) {
          console.error(err.message);
          process.exit(1);
        }
        children.forEach(function(child) {
          this.processPath(path.join(dirname, child), options);
        }.bind(this));
      }.bind(this));
    },
    processFile: function(filename, options) {
      try {
        throw undefined;
      } catch (normalizePath) {
        var ext, moduleName, output, outputFilename;
        normalizePath = function(p) {
          return p.replace(/\\/g, '/');
        };
        var ext = path.extname(filename), basenameNoExt = path.basename(filename, ext), dirname = path.dirname(filename), pathNoExt = normalizePath(path.join(dirname, basenameNoExt)), outputFilename = normalizePath(path.join(options.to, filename)), moduleName = options.anonymous ? null: pathNoExt;
        options = extend({}, options, {m: moduleName});
        this._mkdirp(path.dirname(outputFilename));
        this.processIO(this.fs.createReadStream(filename), this.fs.createWriteStream(outputFilename), options);
      }
    },
    _compile: function(input, moduleName, type, options) {
      var compiler, method;
      type = {
        amd: 'AMD',
        cjs: 'CJS',
        globals: 'Globals'
      }[type];
      compiler = new this.Compiler(input, moduleName, options);
      method = "to" + type;
      return compiler[method]();
    },
    _mkdirp: function(directory) {
      var prefix;
      if (this.fs.existsSync(directory)) {
        return;
      }
      prefix = path.dirname(directory);
      if (prefix !== '.' && prefix !== '/') {
        this._mkdirp(prefix);
      }
      return this.fs.mkdirSync(directory);
    }
  }, {});
  return $CLI;
}();
CLI.start = function(Compiler, argv) {
  var stdin = arguments[2] !== (void 0) ? arguments[2]: process.stdin;
  var stdout = arguments[3] !== (void 0) ? arguments[3]: process.stdout;
  var fs_ = arguments[4] !== (void 0) ? arguments[4]: fs;
  return new CLI(Compiler, stdin, stdout, fs_).start(argv);
};
module.exports = CLI;

//@ sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG1wL3RyYW5zcGlsZWQvY2xpLmpzLmVzNiIsInNvdXJjZXMiOlsidG1wL3RyYW5zcGlsZWQvY2xpLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQUE7dUJDQUEsU0FBQSxDQUFTLE1BQUEsQ0FBUTtBQUNMLEtBQUEsWUFBQSxFQUFjLEVBQUEsQ0FBQSxDQUFJLEtBQUEsQ0FBTSxNQUFBLEVBQVEsT0FBQSxDQUFBLG1CQUEwQixDQUFDLE1BQUEsQ0FBQTtBQUMvRCxLQUFBLEVBQVMsR0FBQSxFQUFBLEVBQUksRUFBQSxDQUFHLEVBQUEsRUFBSSxNQUFBLENBQUEsTUFBQSxDQUFjLEVBQUEsRUFBQSxDQUFLO0FBQ2pDLE9BQUEsS0FBQSxFQUFPLE1BQUEsQ0FBTSxDQUFBLENBQUE7QUFDakIsZUFBQSxDQUFZLElBQUEsQ0FBQSxFQUFRLE9BQUEsQ0FBQSx3QkFBK0IsQ0FBQyxNQUFBLENBQVEsS0FBQSxDQUFBO0FBQUE7QUFFOUQsUUFBTyxZQUFBO0FBQUEsQ0FBQSwyQkNOZixTQUFBLENBQVMsTUFBQSxDQUFRLGFBQUEsQ0FBYztBQUNyQixLQUFBLEtBQUEsRUFBTyxPQUFBLENBQUEsV0FBQTtBQUNYLFFBQUEsQ0FBQSxjQUFxQixDQUFDLE1BQUEsQ0FBUSxjQUFBLENBQWUsRUFBQyxVQUFBLENBQVksTUFBQSxDQUFBLENBQUE7QUFDMUQsTUFBQSxDQUFBLFNBQUEsRUFBaUIsT0FBQTtBQUNqQixRQUFBLENBQUEsZ0JBQXVCLENBQUMsSUFBQSxDQUFNLGtCQUFpQixDQUFDLFlBQUEsQ0FBQSxDQUFBO0FBQ2hELFFBQU8sS0FBQTtBQUFBLENBQUE7QUZKVCxHQUFBLFNBQUEsRUFBVyxRQUFPLENBQUMsVUFBQSxDQUFBO0FBQ25CLEdBQUEsR0FBQSxFQUFLLFFBQU8sQ0FBQyxJQUFBLENBQUE7QUFDYixHQUFBLEtBQUEsRUFBTyxRQUFPLENBQUMsTUFBQSxDQUFBO0FBQ2YsR0FBQSxRQUFBLEVBQVUsUUFBTyxDQUFDLFNBQUEsQ0FBQTtBQUV0QixR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LEVBQUksSUFBQSxDQUFBLEVBQUEsQ0FBQSxVQUFrQixDQUFDLFNBQUEsQ0FBQSxDQUFZO0FBQ2pDLGNBQUE7QUFBQTtBQUVGLFlBQUEsRUFBUyxLQUFBLENBQUEsT0FBWSxDQUFDLFNBQUEsQ0FBQTtBQUN0QixRQUFBLEVBQUksTUFBQSxJQUFXLElBQUEsR0FBTyxPQUFBLElBQVcsSUFBQSxDQUFLO0FBQ3BDLFlBQUEsQ0FBQSxPQUFZLENBQUMsTUFBQSxDQUFBO0FBQUE7QUFFZixZQUFPLEtBQUEsQ0FBQSxFQUFBLENBQUEsU0FBaUIsQ0FBQyxTQUFBLENBQUE7QUFBQTtBQUFBLEdBQUE7QUc3THZCO0NBQ0QsQ0FBQSxDQUFBO0FIZ01MLEdBQUEsQ0FBQSxLQUFBLEVBQVksU0FBQSxDQUFTLFFBQUEsQ0FBVSxLQUFBO0tBQU0sTUFBQSw0Q0FBTSxRQUFBLENBQUEsS0FBQTtLQUFlLE9BQUEsNENBQU8sUUFBQSxDQUFBLE1BQUE7S0FBZ0IsSUFBQSw0Q0FBSSxHQUFBO0FBQ25GLFFBQU8sSUFBSSxJQUFHLENBQUMsUUFBQSxDQUFVLE1BQUEsQ0FBTyxPQUFBLENBQVEsSUFBQSxDQUFBLENBQUEsS0FBVSxDQUFDLElBQUEsQ0FBQTtBQUFBLENBQUE7QUFJckQsTUFBQSxDQUFBLE9BQUEsRUFBaUIsSUFBQSIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xudmFyIG9wdGltaXN0ID0gcmVxdWlyZShcIm9wdGltaXN0XCIpO1xudmFyIGZzID0gcmVxdWlyZShcImZzXCIpO1xudmFyIHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcbnZhciB0aHJvdWdoID0gcmVxdWlyZShcInRocm91Z2hcIik7XG5cbmZ1bmN0aW9uIGV4dGVuZCh0YXJnZXQsIC4uLnNvdXJjZXMpIHtcbiAgdmFyIHRvU3RyaW5nID0ge30udG9TdHJpbmc7XG5cbiAgc291cmNlcy5mb3JFYWNoKGZ1bmN0aW9uKHNvdXJjZSkge1xuICAgIGZvciAodmFyIGtleSBpbiBzb3VyY2UpIHtcbiAgICAgIHRhcmdldFtrZXldID0gc291cmNlW2tleV07XG4gICAgfVxuICB9KTtcblxuICByZXR1cm4gdGFyZ2V0O1xufVxuXG5jbGFzcyBDTEkge1xuICBjb25zdHJ1Y3RvcihDb21waWxlciwgc3RkaW49cHJvY2Vzcy5zdGRpbiwgc3Rkb3V0PXByb2Nlc3Muc3Rkb3V0LCBmc189ZnMpIHtcbiAgICB0aGlzLkNvbXBpbGVyID0gQ29tcGlsZXI7XG4gICAgdGhpcy5zdGRpbiA9IHN0ZGluO1xuICAgIHRoaXMuc3Rkb3V0ID0gc3Rkb3V0O1xuICAgIHRoaXMuZnMgPSBmc187XG4gIH1cblxuICBzdGFydChhcmd2KSB7XG4gICAgdmFyIG9wdGlvbnMgPSB0aGlzLnBhcnNlQXJncyhhcmd2KTtcblxuICAgIGlmIChvcHRpb25zLmhlbHApIHtcbiAgICAgIHRoaXMuYXJnUGFyc2VyKGFyZ3YpLnNob3dIZWxwKCk7XG4gICAgfSBlbHNlIGlmIChvcHRpb25zLnN0ZGlvKSB7XG4gICAgICB0aGlzLnByb2Nlc3NTdGRpbyhvcHRpb25zKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvcHRpb25zLl8ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgdmFyIGZpbGVuYW1lID0gb3B0aW9ucy5fW2ldO1xuICAgICAgICB0aGlzLnByb2Nlc3NQYXRoKGZpbGVuYW1lLCBvcHRpb25zKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwYXJzZUFyZ3MoYXJndikge1xuICAgIHZhciBhcmdzID0gdGhpcy5hcmdQYXJzZXIoYXJndikuYXJndjtcblxuICAgIGlmIChhcmdzLmltcG9ydHMpIHtcbiAgICAgIHZhciBpbXBvcnRzID0ge307XG4gICAgICBhcmdzLmltcG9ydHMuc3BsaXQoJywnKS5mb3JFYWNoKGZ1bmN0aW9uKHBhaXIpIHtcbiAgICAgICAgdmFyIFtyZXF1aXJlUGF0aCwgZ2xvYmFsXSA9IHBhaXIuc3BsaXQoJzonKTtcbiAgICAgICAgaW1wb3J0c1tyZXF1aXJlUGF0aF0gPSBnbG9iYWw7XG4gICAgICB9KTtcbiAgICAgIGFyZ3MuaW1wb3J0cyA9IGltcG9ydHM7XG4gICAgfVxuXG4gICAgaWYgKGFyZ3MuZ2xvYmFsKSB7XG4gICAgICBhcmdzLmludG8gPSBhcmdzLmdsb2JhbDtcbiAgICB9XG5cbiAgICByZXR1cm4gYXJncztcbiAgfVxuXG4gIGFyZ1BhcnNlcihhcmd2KSB7XG4gICAgcmV0dXJuIG9wdGltaXN0KGFyZ3YpLnVzYWdlKCdjb21waWxlLW1vZHVsZXMgdXNhZ2U6XFxuXFxuICBVc2luZyBmaWxlczpcXG4gICAgY29tcGlsZS1tb2R1bGVzIElOUFVUIC0tdG8gRElSIFstLWFub255bW91c10gWy0tdHlwZSBUWVBFXSBbLS1pbXBvcnRzIFBBVEg6R0xPQkFMXVxcblxcbiAgVXNpbmcgc3RkaW86XFxuICAgIGNvbXBpbGUtbW9kdWxlcyAtLXN0ZGlvIFstLXR5cGUgVFlQRV0gWy0taW1wb3J0cyBQQVRIOkdMT0JBTF0gKC0tbW9kdWxlLW5hbWUgTU9EfC0tYW5vbnltb3VzKScpLm9wdGlvbnMoe1xuICAgICAgdHlwZToge1xuICAgICAgICBcImRlZmF1bHRcIjogJ2FtZCcsXG4gICAgICAgIGRlc2NyaWJlOiAnVGhlIHR5cGUgb2Ygb3V0cHV0IChvbmUgb2YgXCJhbWRcIiwgXCJjanNcIiwgb3IgXCJnbG9iYWxzXCIpJ1xuICAgICAgfSxcbiAgICAgIHRvOiB7XG4gICAgICAgIGRlc2NyaWJlOiAnQSBkaXJlY3RvcnkgaW4gd2hpY2ggdG8gd3JpdGUgdGhlIHJlc3VsdGluZyBmaWxlcydcbiAgICAgIH0sXG4gICAgICBpbXBvcnRzOiB7XG4gICAgICAgIGRlc2NyaWJlOiAnQSBsaXN0IG9mIHBhdGg6Z2xvYmFsIHBhaXJzLCBjb21tYSBzZXBhcmF0ZWQgKGUuZy4ganF1ZXJ5OiQsZW1iZXI6RW1iZXIpJ1xuICAgICAgfSxcbiAgICAgIGFub255bW91czoge1xuICAgICAgICBcImRlZmF1bHRcIjogZmFsc2UsXG4gICAgICAgIHR5cGU6ICdib29sZWFuJyxcbiAgICAgICAgZGVzY3JpYmU6ICdEbyBub3QgaW5jbHVkZSBhIG1vZHVsZSBuYW1lJ1xuICAgICAgfSxcbiAgICAgICdtb2R1bGUtbmFtZSc6IHtcbiAgICAgICAgZGVzY3JpYmU6ICdUaGUgbmFtZSBvZiB0aGUgb3V0cHV0dGVkIG1vZHVsZScsXG4gICAgICAgIGFsaWFzOiAnbSdcbiAgICAgIH0sXG4gICAgICBzdGRpbzoge1xuICAgICAgICBcImRlZmF1bHRcIjogZmFsc2UsXG4gICAgICAgIHR5cGU6ICdib29sZWFuJyxcbiAgICAgICAgYWxpYXM6ICdzJyxcbiAgICAgICAgZGVzY3JpYmU6ICdVc2Ugc3RkaW4gYW5kIHN0ZG91dCB0byBwcm9jZXNzIGEgZmlsZSdcbiAgICAgIH0sXG4gICAgICBnbG9iYWw6IHtcbiAgICAgICAgZGVzY3JpYmU6ICdXaGVuIHRoZSB0eXBlIGlzIGBnbG9iYWxzYCwgdGhlIG5hbWUgb2YgdGhlIGdsb2JhbCB0byBleHBvcnQgaW50bydcbiAgICAgIH0sXG4gICAgICBoZWxwOiB7XG4gICAgICAgIFwiZGVmYXVsdFwiOiBmYWxzZSxcbiAgICAgICAgdHlwZTogJ2Jvb2xlYW4nLFxuICAgICAgICBhbGlhczogJ2gnLFxuICAgICAgICBkZXNjcmliZTogJ1Nob3dzIHRoaXMgaGVscCBtZXNzYWdlJ1xuICAgICAgfVxuICAgIH0pLmNoZWNrKCh7dHlwZX0pID0+IHR5cGUgPT09ICdhbWQnIHx8IHR5cGUgPT09ICdjanMnIHx8IHR5cGUgPT09ICdnbG9iYWxzJylcbiAgICAuY2hlY2soYXJncyA9PiAhYXJncy5hbm9ueW1vdXMgfHwgIWFyZ3MubSlcbiAgICAuY2hlY2soYXJncyA9PiAoYXJncy5zdGRpbyAmJiBhcmdzLnR5cGUgPT09ICdhbWQnKSA/IGFyZ3MuYW5vbnltb3VzIHx8IGFyZ3MubSB8fCBmYWxzZSA6IHRydWUpXG4gICAgLmNoZWNrKGFyZ3MgPT4gYXJncy5zdGRpbyB8fCBhcmdzLnRvIHx8IGFyZ3MuaGVscClcbiAgICAuY2hlY2soYXJncyA9PiBhcmdzLmltcG9ydHMgPyBhcmdzLnR5cGUgPT09ICdnbG9iYWxzJyA6IGFyZ3MudHlwZSAhPT0gJ2dsb2JhbHMnKTtcbiAgfVxuXG4gIHByb2Nlc3NTdGRpbyhvcHRpb25zKSB7XG4gICAgdGhpcy5wcm9jZXNzSU8odGhpcy5zdGRpbiwgdGhpcy5zdGRvdXQsIG9wdGlvbnMpO1xuICB9XG5cbiAgcHJvY2Vzc0lPKGlucHV0LCBvdXRwdXQsIG9wdGlvbnMpIHtcbiAgICB2YXIgZGF0YSA9ICcnLFxuICAgICAgICBzZWxmID0gdGhpcztcblxuICAgIGZ1bmN0aW9uIHdyaXRlKGNodW5rKSB7XG4gICAgICBkYXRhICs9IGNodW5rO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGVuZCgpIHtcbiAgICAgIHRoaXMucXVldWUoc2VsZi5fY29tcGlsZShkYXRhLCBvcHRpb25zLm0sIG9wdGlvbnMudHlwZSwgb3B0aW9ucykpO1xuICAgICAgdGhpcy5xdWV1ZShudWxsKTtcbiAgICB9XG5cbiAgICBpbnB1dC5waXBlKHRocm91Z2god3JpdGUsIGVuZCkpLnBpcGUob3V0cHV0KTtcbiAgfVxuXG4gIHByb2Nlc3NQYXRoKGZpbGVuYW1lLCBvcHRpb25zKSB7XG4gICAgdGhpcy5mcy5zdGF0KGZpbGVuYW1lLCBmdW5jdGlvbihlcnIsIHN0YXQpIHtcbiAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnIubWVzc2FnZSk7XG4gICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgIH0gZWxzZSBpZiAoc3RhdC5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAgIHRoaXMucHJvY2Vzc0RpcmVjdG9yeShmaWxlbmFtZSwgb3B0aW9ucyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnByb2Nlc3NGaWxlKGZpbGVuYW1lLCBvcHRpb25zKTtcbiAgICAgIH1cbiAgICB9LmJpbmQodGhpcykpO1xuICB9XG5cbiAgcHJvY2Vzc0RpcmVjdG9yeShkaXJuYW1lLCBvcHRpb25zKSB7XG4gICAgdGhpcy5mcy5yZWFkZGlyKGRpcm5hbWUsIGZ1bmN0aW9uKGVyciwgY2hpbGRyZW4pIHtcbiAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnIubWVzc2FnZSk7XG4gICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgIH1cbiAgICAgIGNoaWxkcmVuLmZvckVhY2goZnVuY3Rpb24oY2hpbGQpIHtcbiAgICAgICAgdGhpcy5wcm9jZXNzUGF0aChwYXRoLmpvaW4oZGlybmFtZSwgY2hpbGQpLCBvcHRpb25zKTtcbiAgICAgIH0uYmluZCh0aGlzKSk7XG4gICAgfS5iaW5kKHRoaXMpKTtcbiAgfVxuXG4gIHByb2Nlc3NGaWxlKGZpbGVuYW1lLCBvcHRpb25zKSB7XG4gICAgdmFyIGV4dCwgbW9kdWxlTmFtZSwgb3V0cHV0LCBvdXRwdXRGaWxlbmFtZTtcblxuICAgIGZ1bmN0aW9uIG5vcm1hbGl6ZVBhdGgocCkge1xuICAgICAgcmV0dXJuIHAucmVwbGFjZSgvXFxcXC9nLCAnLycpO1xuICAgIH1cblxuICAgIHZhciBleHQgICAgICAgICAgICA9IHBhdGguZXh0bmFtZShmaWxlbmFtZSksXG4gICAgICAgIGJhc2VuYW1lTm9FeHQgID0gcGF0aC5iYXNlbmFtZShmaWxlbmFtZSwgZXh0KSxcbiAgICAgICAgZGlybmFtZSAgICAgICAgPSBwYXRoLmRpcm5hbWUoZmlsZW5hbWUpLFxuICAgICAgICBwYXRoTm9FeHQgICAgICA9IG5vcm1hbGl6ZVBhdGgocGF0aC5qb2luKGRpcm5hbWUsIGJhc2VuYW1lTm9FeHQpKSxcbiAgICAgICAgb3V0cHV0RmlsZW5hbWUgPSBub3JtYWxpemVQYXRoKHBhdGguam9pbihvcHRpb25zLnRvLCBmaWxlbmFtZSkpLFxuICAgICAgICBtb2R1bGVOYW1lICAgICA9IG9wdGlvbnMuYW5vbnltb3VzID8gbnVsbCA6IHBhdGhOb0V4dDtcblxuICAgIG9wdGlvbnMgPSBleHRlbmQoe30sIG9wdGlvbnMsIHttOiBtb2R1bGVOYW1lfSk7XG4gICAgdGhpcy5fbWtkaXJwKHBhdGguZGlybmFtZShvdXRwdXRGaWxlbmFtZSkpO1xuXG4gICAgdGhpcy5wcm9jZXNzSU8oXG4gICAgICB0aGlzLmZzLmNyZWF0ZVJlYWRTdHJlYW0oZmlsZW5hbWUpLFxuICAgICAgdGhpcy5mcy5jcmVhdGVXcml0ZVN0cmVhbShvdXRwdXRGaWxlbmFtZSksXG4gICAgICBvcHRpb25zXG4gICAgKTtcbiAgfVxuXG4gIF9jb21waWxlKGlucHV0LCBtb2R1bGVOYW1lLCB0eXBlLCBvcHRpb25zKSB7XG4gICAgdmFyIGNvbXBpbGVyLCBtZXRob2Q7XG4gICAgdHlwZSA9IHtcbiAgICAgIGFtZDogJ0FNRCcsXG4gICAgICBjanM6ICdDSlMnLFxuICAgICAgZ2xvYmFsczogJ0dsb2JhbHMnXG4gICAgfVt0eXBlXTtcbiAgICBjb21waWxlciA9IG5ldyB0aGlzLkNvbXBpbGVyKGlucHV0LCBtb2R1bGVOYW1lLCBvcHRpb25zKTtcbiAgICBtZXRob2QgPSBcInRvXCIgKyB0eXBlO1xuICAgIHJldHVybiBjb21waWxlclttZXRob2RdKCk7XG4gIH1cblxuICBfbWtkaXJwKGRpcmVjdG9yeSkge1xuICAgIHZhciBwcmVmaXg7XG4gICAgaWYgKHRoaXMuZnMuZXhpc3RzU3luYyhkaXJlY3RvcnkpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHByZWZpeCA9IHBhdGguZGlybmFtZShkaXJlY3RvcnkpO1xuICAgIGlmIChwcmVmaXggIT09ICcuJyAmJiBwcmVmaXggIT09ICcvJykge1xuICAgICAgdGhpcy5fbWtkaXJwKHByZWZpeCk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmZzLm1rZGlyU3luYyhkaXJlY3RvcnkpO1xuICB9XG59XG5cbkNMSS5zdGFydCA9IGZ1bmN0aW9uKENvbXBpbGVyLCBhcmd2LCBzdGRpbj1wcm9jZXNzLnN0ZGluLCBzdGRvdXQ9cHJvY2Vzcy5zdGRvdXQsIGZzXz1mcykge1xuICByZXR1cm4gbmV3IENMSShDb21waWxlciwgc3RkaW4sIHN0ZG91dCwgZnNfKS5zdGFydChhcmd2KTtcbn07XG5cblxubW9kdWxlLmV4cG9ydHMgPSBDTEk7Il19